# lesson17

**Домашнее задание**

Настроить стенд Vagrant с двумя виртуальными машинами server и client.

Настроить политику бэкапа директории /etc с клиента:
1) Полный бэкап - раз в день
2) Инкрементальный - каждые 10 минут
3) Дифференциальный - каждые 30 минут


Для этого домашнего задания будет поднято две виртуальные машины - сервер бэкапов и клиент. В приложенном вагрант файле поднимаются две преднастроенных ВМ. 

Выполнение</br>
Пишем vagrantfile</br>
Первое что мы делаем это устанавливаем Borg Backup на обе ВМ, но сначала устанавливаем epel репозиторий yum install epel-release -y; yum install borgbackup -y</br>
Далее создаем пользователя borg на обоих машинах useradd -m borg</br>
Так как borg будет делать резервные копии на сервер бэкапов, то нам необходимо включить авторизацию по ssh ключам, для этого необходимо сформировать ssh ключ на клиенте командой ssh-keygen под пользователем borg и root (на все вопросы нажимаем enter)</br>
Далее создаем на клиенте в /home/borg/.ssh/ папку keys, куда перемещаем из /home/borg/.ssh/ наши созданные ключи</br>
Далее на клиенте в /home/borg/.ssh/ создаем файл с названием config и следующим содержимым:</br>

![image](https://github.com/movik242/lesson17/assets/143793993/4375cc3a-a03e-4f5f-84b5-9d876708095d)

Здесь указывается сервер к которому будем подключаться и путь до закрытого ключа на клиенте, т.е. на сервере у нас будет открытый ключ, а на клиенте закрытый ключ

Далее необходимо скопировать открытый ключ из файла (с клиента) id_rsa.pub в файл /home/borg/.ssh/authorized_keys на сервер бэкапов и привести файл к такому виду (так как ВМ у меня тестовые то привожу вывод файла, если у вас продакшен, о ваших ключах никто не должен знать):</br>

![image](https://github.com/movik242/lesson17/assets/143793993/65801d3b-1d6a-4e33-8bc2-14babe292cbc)

ВАЖНО! Необходимо чтобы и на сервере и на клиенте в директориях /home/borg/.ssh для папок были права 700, а для файлов 600. Задается утилитой chmod. Если не правильные права то работать не будет.

Далее необходимо в /etc/hosts на клиенте ввести сопоставление адреса и имени сервера, для клиента:

192.168.40.22 borgserver</br>
На сервере:</br>

192.168.40.23 borgclient</br>
Протестировать работоспособность можно введя под пользователем borg (на клиенте), команду ssh borg@borgserver.</br>

![image](https://github.com/movik242/lesson17/assets/143793993/3c985d98-4960-4831-bdcd-66bfa63ea0c7)

Далее нам надо инициализировать с клиента репозитории Borg Backup командой borg init -e none borg@borgserver:/var/backup/, там будут храниться файлы резервных копий

    borg init -e none borg@borgserver:/var/backup/

Далее мы можем командой borg create --stats --list borg@borgserver:/var/backup/::"etc-{now:%Y-%m-%d_%H:%M:%S}" /etc создать свою первую резервную копию</br>
Здесь указаны такие ключи как --stats это означает выводить статистику, --list выводит в процессе листинг файлов которые резервируются, в самом конце указываем директорию, которую бэкапим

![image](https://github.com/movik242/lesson17/assets/143793993/a38ea9ae-495c-4a5f-8671-bd407e227bf2)

Достать файл из резервной копии можно слудующей командой borg extract borg@borgserver:/var/backup::etc-2024-03-07_10:12:27 etc/hostname 

Далее мы автоматизируем выполнение резервных копий, сервисом systemd, служба, которая запускается по таймеру.

![image](https://github.com/movik242/lesson17/assets/143793993/b6ba9c9f-996a-4b5e-82f8-5e6e84ada124)

![image](https://github.com/movik242/lesson17/assets/143793993/c1d17e8a-7750-4ab5-ac3e-1c8b01a45583)



